#!/usr/bin/env zsh
autoload -Uz add-zsh-hook

# -------------------------------
# Aliases
# -------------------------------
# New Alias
alias update='sudo apt update && sudo apt upgrade -y'
alias cls='clear'
alias clearNoMessage='clear'
alias clearMessage='clear && generate_message'
# alias install='sudo apt install -y'    # add automated install, pass params

# file aliases (open with code for these extensions)
alias -s txt=code
alias -s py=code
alias -s json=code
alias -s pcapng=wireshark
alias -s html=code
alias -s js=code
alias -s css=code

# -------------------------------
# Functions
# -------------------------------

generate_message() {
  local hour
  hour=$(date +%H)
  hour=${hour#0}

  local RED=$'\e[0;31m'
  local GREEN=$'\e[0;32m'
  local YELLOW=$'\e[0;33m'
  local BLUE=$'\e[0;34m'
  local MAGENTA=$'\e[0;35m'
  local CYAN=$'\e[0;36m'
  local RESET=$'\e[0m'

  local -a late_night_msgs
  late_night_msgs=(
    "${RED}Wth are you doing awake, go to sleep hasshole -_-${RESET}"
    "${RED}You should be dreaming, not staring at a terminalâ€¦ (â•¯ï¸µâ•°,)${RESET}"
    "${RED}It's way too lateâ€¦ don't make me tuck you in ( ï¿£ï¸¿ï¿£)${RESET}"
    "${RED}Sleep deprivation isn't a flex, go to bed! (ëˆˆ_ëˆˆ)${RESET}"
    "${RED}Your pillow misses you, don't be cruel (ã¤â‰§â–½â‰¦)ã¤${RESET}"
    "${RED}Go to bed, or I'll personally turn off your computer à² _à² ${RESET}"
    "${RED}Still here? Your bed is warm and waiting for you (ã£Ë˜Ï‰Ë˜Ï‚ )ğŸ’¤${RESET}"
    "${RED}The stars are watching over youâ€¦ sleep well, please (âœ¿â—•â€¿â—•)${RESET}"
  )

  local -a morning_msgs
  morning_msgs=(
    "${YELLOW}Have you done breakfast? No? Shame on you (Â¬â€¿Â¬)${RESET}"
    "${YELLOW}Morning! Time to fuel up or you'll regret it later âŠ‚(ï¿£â–½ï¿£)âŠƒ${RESET}"
    "${YELLOW}No food, no energy. No energy, no life. Go eat. (ãƒà² ç›Šà² )ãƒ${RESET}"
    "${YELLOW}Did you sleep well? Or are you a walking zombie? (âŠ™_â—)${RESET}"
    "${YELLOW}Morninâ€™ sunshine! The world says UwU âœ¨${RESET}"
    "${YELLOW}Hope youâ€™re feeling rested, if not, go take a nap after coffee (â˜•Ë˜ï½¥á´—ï½¥Ë˜)${RESET}"
    "${YELLOW}Wake up, sleepyhead! The universe is waiting for you (ï¾‰â—•ãƒ®â—•)ï¾‰*:ï½¥ï¾Ÿâœ§${RESET}"
  )

  local -a afternoon_msgs
  afternoon_msgs=(
    "${CYAN}Nothin to do uh? -_- Well, at least you're here.${RESET}"
    "${CYAN}Youre still alive, right? (o_O)${RESET}"
    "${CYAN}Go touch some grass, nerd â”(ï¿£ãƒ˜ï¿£)â”Œ${RESET}"
    "${CYAN}Workin' hard or hardly workin'? (Â¬â€¿Â¬)${RESET}"
    "${CYAN}Hope your day's going wellâ€¦ If not, wanna talk? (ï½¡â€¢ áµ• â€¢ï½¡) â¤ï¸${RESET}"
    "${CYAN}Bored? How about a nap? Or a cookie? Both? ğŸª${RESET}"
    "${CYAN}Take a break, even heroes need to rest (à¸‡â€™Ì€-'Ì)à¸‡${RESET}"
    "${CYAN}If youâ€™re feeling tired, just close your eyes for a momentâ€¦${RESET}"
  )

  local -a evening_msgs
  evening_msgs=(
    "${MAGENTA}Câ€™mon, go to bed. You need your beauty sleep ( Ë˜ï¸¹Ë˜ )${RESET}"
    "${MAGENTA}I see you. Still here. Why? Go rest! (*ï¿£3ï¿£)â•­${RESET}"
    "${MAGENTA}You had a long day, right? Be kind to yourself, okay? (ã£'Ï‰')ã£${RESET}"
    "${MAGENTA}Donâ€™t make me come over there and force you to sleep ( à² _à² )${RESET}"
    "${MAGENTA}Youâ€™re still up? You better be cozy at least! (ã¥ï¿£ Â³ï¿£)ã¥ğŸ’¤${RESET}"
    "${MAGENTA}Go to bed, sweetheart. You're important. Take care. (âœ¿Ë¶Ë˜ Â³Ë˜)~â™¥${RESET}"
    "${MAGENTA}If no one told you today: I'm proud of you. Now rest, please. (ã£Ë˜Ğ·Ë˜âŒ£Ë˜)${RESET}"
    "${MAGENTA}Nighttime is for dreaming, not stressing. Let go, sleep tight. (â—¡â€¿â—¡âœ¿)${RESET}"
  )

  local -a messages
  if (( hour < 6 )); then
    messages=("${(j:,:)late_night_msgs}")
    messages=( ${late_night_msgs[@]} )
  elif (( hour < 12 )); then
    messages=( ${morning_msgs[@]} )
  elif (( hour < 18 )); then
    messages=( ${afternoon_msgs[@]} )
  else
    messages=( ${evening_msgs[@]} )
  fi

  local random_index=$(( (RANDOM % ${#messages[@]}) + 1 ))
  printf '%b\n' "${messages[$random_index]}"
}

# -------------------------------
# Config prompt & environment
# -------------------------------
export HISTFILE=~/.zsh_history
export HISTSIZE=10000
export SAVEHIST=10000
setopt append_history
setopt hist_ignore_dups
setopt hist_ignore_all_dups
setopt share_history

prompt_uid_check(){
  if [[ $(id -u) -eq 0 ]]; then
    echo "You are root"
    clearNoMessage
    generate_message
    PROMPT=$'%F{red}%B%n@%m%f:%F{magenta}%B%~%f\n%#> '
    RPROMPT='%F{yellow}%D{%H:%M:%S}%f'
    export LS_COLORS='di=1;34:fi=0;32:ln=1;36:pi=40;33:so=1;35:do=1;33:bd=1;33'
    printf '%b\n' "This shell is $SHELL and it uses autosuggestions"
    printf '%b\n' "Type 'update' for apt update && apt upgrade"
  else
    clearNoMessage
    generate_message
    PROMPT=$'%F{blue}%B%n@%m%f:%F{magenta}%B%~%f\n%#> '
    RPROMPT='%F{yellow}%D{%H:%M:%S}%f'
    export LS_COLORS='di=1;34:fi=0;32:ln=1;36:pi=40;33:so=1;35:do=1;33:bd=1;33'
    printf '%b\n' "This shell is $SHELL and it uses autosuggestions"
    printf '%b\n' "Type 'update' for apt update && apt upgrade"
  fi
}

# -------------------------------
# Function "unico"
# -------------------------------
unico() {
  if [[ $# -lt 2 ]] || [[ $1 == "-h" ]]; then
    printf 'Usage: unico <agent_id> <api_key>\n'
    return 1
  fi

  if ! command -v curl >/dev/null 2>&1; then
    printf 'curl is not installed\n'
    return 2
  fi

  if ! command -v jq >/dev/null 2>&1; then
    printf 'jq is not installed, please install it with: sudo apt install jq -y. Do you want to install it now? (y/n)\n'
    local key
    read key
    if [[ $key == 'y' || $key == 'Y' ]]; then
      sudo apt install jq -y
    else
      printf 'jq is required to use this function\n'
      return 3
    fi
  fi

  # Chiamata API
  local response
  response=$(curl -s -X POST "https://pr-107.theunico.it/api/agents/$1/completions" \
    -H "Authorization: Bearer $2" \
    -H "Content-Type: application/json" \
    -d '{"query": "ciao, cosa Ã¨ unico? Spiegami tutto nel dettaglio", "model": "gemini-2.0-flash"}')

  # Pulizia e stampa colorata delle prime due righe (se disponibili)
  local clean_response
  clean_response=$(printf '%s' "$response" | tr -d '\000-\037')
  printf '%s\n' "$clean_response" | jq -r '.text' | awk 'NR==1{printf "\033[0;31m%s\033[0m\n", $0} NR==2{printf "\033[0;32m%s\033[0m\n", $0} NR>2{print}'
}

add-zsh-hook precmd prompt_uid_check

# -------------------------------
# EOF
# -------------------------------
